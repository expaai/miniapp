name: Deploy Backend to VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Backend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞..."
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
          systemctl stop career-backend || echo "–°–µ—Ä–≤–∏—Å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          
          # –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          if [ -d "/home/${{ secrets.VPS_USERNAME }}/career-miniapp/backend" ]; then
            cp -r /home/${{ secrets.VPS_USERNAME }}/career-miniapp/backend /home/${{ secrets.VPS_USERNAME }}/career-miniapp/backend.backup.$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω"
          fi
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /home/${{ secrets.VPS_USERNAME }}
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          rm -rf career-miniapp-temp
          git clone https://github.com/${{ github.repository }}.git career-miniapp-temp
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π backend
          cp -r career-miniapp-temp/backend/* /home/${{ secrets.VPS_USERNAME }}/career-miniapp/backend/
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–µ–Ω–¥–∞
          cd /home/${{ secrets.VPS_USERNAME }}/career-miniapp/backend
          
          # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          source venv/bin/activate
          
          # –û–±–Ω–æ–≤–ª—è–µ–º pip
          pip install --upgrade pip
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
          pip install --no-cache-dir --force-reinstall -r requirements.txt
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é httpx
          pip show httpx | grep Version
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          systemctl start career-backend
          echo "‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
          if systemctl is-active --quiet career-backend; then
            echo "‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
            systemctl status career-backend
            journalctl -u career-backend --no-pager -n 20
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          sleep 5
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ Health check –ø—Ä–æ—à–µ–ª"
          else
            echo "‚ùå Health check –Ω–µ –ø—Ä–æ—à–µ–ª"
            curl -v http://localhost:8000/health || true
            exit 1
          fi
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -rf /home/${{ secrets.VPS_USERNAME }}/career-miniapp-temp
          
          echo "üéâ –î–µ–ø–ª–æ–π –±—ç–∫–µ–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"