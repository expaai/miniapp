name: Deploy Backend to VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Backend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd /home/${{ secrets.VPS_USERNAME }}/career-miniapp || {
            echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            exit 1
          }
          
          # –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          if [ -d "backend" ]; then
            cp -r backend backend.backup.$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω"
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ Git
          git fetch origin
          git reset --hard origin/main
          echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ Git"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–µ–Ω–¥–∞
          cd backend
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          source venv/bin/activate
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          pip install -r requirements.txt
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ httpx –≤–µ—Ä—Å–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
          pip show httpx | grep Version
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          sudo systemctl restart career-backend
          echo "‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
          
          # –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
          sleep 5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
          if sudo systemctl is-active --quiet career-backend; then
            echo "‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
            sudo systemctl status career-backend
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ Health check –ø—Ä–æ—à–µ–ª"
          else
            echo "‚ùå Health check –Ω–µ –ø—Ä–æ—à–µ–ª"
            exit 1
          fi
          
          echo "üéâ –î–µ–ø–ª–æ–π –±—ç–∫–µ–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"