name: Deploy Backend to VPS

on:
  workflow_dispatch:  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫, —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'backend/**'
  #     - '.github/workflows/deploy-backend.yml'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Backend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞..."
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
          sudo systemctl stop career-backend || echo "–°–µ—Ä–≤–∏—Å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          
          # –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          if [ -d "/opt/career-backend" ] && [ "$(ls -A /opt/career-backend)" ]; then
            sudo cp -r /opt/career-backend /opt/career-backend.backup.$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω"
          fi
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /tmp
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          rm -rf career-miniapp
          git clone https://github.com/${{ github.repository }}.git career-miniapp
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π backend
          sudo cp -r career-miniapp/backend/* /opt/career-backend/
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–µ–Ω–¥–∞
          cd /opt/career-backend
          
          # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -d "venv" ]; then
            sudo python3 -m venv venv
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º pip –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          sudo venv/bin/pip install --upgrade pip
          sudo venv/bin/pip install --no-cache-dir --force-reinstall -r requirements.txt
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é httpx
          sudo venv/bin/python -c "import httpx; print(f'httpx version: {httpx.__version__}')"
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          sudo chown -R www-data:www-data /opt/career-backend
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          sudo systemctl start career-backend
          echo "‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
          if sudo systemctl is-active --quiet career-backend; then
            echo "‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
            sudo systemctl status career-backend
            sudo journalctl -u career-backend --no-pager -n 20
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          sleep 5
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ Health check –ø—Ä–æ—à–µ–ª"
          else
            echo "‚ùå Health check –Ω–µ –ø—Ä–æ—à–µ–ª"
            curl -v http://localhost:8000/health || true
            exit 1
          fi
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -rf /tmp/career-miniapp
          
          echo "üéâ –î–µ–ø–ª–æ–π –±—ç–∫–µ–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"