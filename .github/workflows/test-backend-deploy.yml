name: Test Backend Deploy

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

jobs:
  test-deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test Deploy Backend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "üß™ –¢–µ—Å—Ç–æ–≤—ã–π –¥–µ–ø–ª–æ–π –±—ç–∫–µ–Ω–¥–∞..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          echo "üìã –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞:"
          sudo systemctl status career-backend || echo "–°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ /opt/career-backend:"
          ls -la /opt/career-backend/ || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
          if [ -f "/opt/career-backend/venv/bin/python" ]; then
            sudo /opt/career-backend/venv/bin/python --version
            sudo /opt/career-backend/venv/bin/pip list | grep httpx || echo "httpx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          else
            echo "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
          
          echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API:"
          curl -v http://localhost:8000/health || echo "API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          
          echo "üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
          echo "Python –≤–µ—Ä—Å–∏—è: $(python3 --version)"
          echo "–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ: $(df -h /opt | tail -1)"
          echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 8000: $(sudo lsof -i :8000 || echo '–ü–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω')"
          
          echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"