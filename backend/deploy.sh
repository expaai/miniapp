#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è Career Mini App Backend –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Career Mini App Backend..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example"
    echo "cp .env.example .env"
    echo "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à OPENAI_API_KEY"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ OPENAI_API_KEY
if ! grep -q "OPENAI_API_KEY=sk-" .env; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á OpenAI"
fi

echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down

echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π Docker –æ–±—Ä–∞–∑..."
docker-compose build --no-cache

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose up -d

echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º health check
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞..."
if curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo "‚úÖ Backend —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo "üìñ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs"
    echo "üíö Health check: http://localhost:8000/health"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ backend —Å–µ—Ä–≤–∏—Å–∞"
    echo "üìã –õ–æ–≥–∏:"
    docker-compose logs career-backend
    exit 1
fi

echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  –õ–æ–≥–∏:           docker-compose logs -f career-backend"
echo "  –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:     docker-compose down"
echo "  –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:  docker-compose restart career-backend"
echo "  –°—Ç–∞—Ç—É—Å:         docker-compose ps"
echo ""
echo "üîó Endpoints:"
echo "  Health:         http://localhost:8000/health"
echo "  Upload Resume:  http://localhost:8000/upload-resume"
echo "  Analyze AI:     http://localhost:8000/analyze-resume-ai"
echo "  API Docs:       http://localhost:8000/docs"