#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ ััะฐัััะฐ ะดะตะฟะปะพั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scripts/monitor-deploy.sh

echo "๐ ะะพะฝะธัะพัะธะฝะณ ััะฐัััะฐ ะดะตะฟะปะพั..."
echo "๐ ะัะบัะพะนัะต GitHub Actions ะดะปั ะดะตัะฐะปัะฝะพะณะพ ะฟัะพัะผะพััะฐ: https://github.com/expaai/miniapp/actions"
echo ""

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ััะฐัััะฐ API
check_api_status() {
    echo "๐ ะัะพะฒะตััั ััะฐััั API..."
    
    # ะัะพะฒะตััะตะผ ะปะพะบะฐะปัะฝัะน API (ะตัะปะธ ะทะฐะฟััะตะฝ)
    if curl -s http://localhost:8000/health > /dev/null 2>&1; then
        echo "โ ะะพะบะฐะปัะฝัะน API (localhost:8000) - ัะฐะฑะพัะฐะตั"
    else
        echo "โ ะะพะบะฐะปัะฝัะน API (localhost:8000) - ะฝะตะดะพัััะฟะตะฝ"
    fi
    
    # ะัะพะฒะตััะตะผ ะฟัะพะดะฐะบัะตะฝ API
    if curl -s https://api.expa-ai.ru/health > /dev/null 2>&1; then
        echo "โ ะัะพะดะฐะบัะตะฝ API (api.expa-ai.ru) - ัะฐะฑะพัะฐะตั"
    else
        echo "โ ะัะพะดะฐะบัะตะฝ API (api.expa-ai.ru) - ะฝะตะดะพัััะฟะตะฝ"
    fi
    
    echo ""
}

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ััะฐัััะฐ ััะพะฝัะตะฝะดะฐ
check_frontend_status() {
    echo "๐ ะัะพะฒะตััั ััะฐััั ััะพะฝัะตะฝะดะฐ..."
    
    # ะัะพะฒะตััะตะผ ะปะพะบะฐะปัะฝัะน ััะพะฝัะตะฝะด
    if curl -s http://localhost:3000 > /dev/null 2>&1; then
        echo "โ ะะพะบะฐะปัะฝัะน ััะพะฝัะตะฝะด (localhost:3000) - ัะฐะฑะพัะฐะตั"
    else
        echo "โ ะะพะบะฐะปัะฝัะน ััะพะฝัะตะฝะด (localhost:3000) - ะฝะตะดะพัััะฟะตะฝ"
    fi
    
    # ะัะพะฒะตััะตะผ ะฟัะพะดะฐะบัะตะฝ ััะพะฝัะตะฝะด
    if curl -s https://expa-ai.ru > /dev/null 2>&1; then
        echo "โ ะัะพะดะฐะบัะตะฝ ััะพะฝัะตะฝะด (expa-ai.ru) - ัะฐะฑะพัะฐะตั"
    else
        echo "โ ะัะพะดะฐะบัะตะฝ ััะพะฝัะตะฝะด (expa-ai.ru) - ะฝะตะดะพัััะฟะตะฝ"
    fi
    
    echo ""
}

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ Docker ะบะพะฝัะตะนะฝะตัะพะฒ
check_docker_status() {
    echo "๐ ะัะพะฒะตััั ััะฐััั Docker ะบะพะฝัะตะนะฝะตัะพะฒ..."
    
    if command -v docker > /dev/null 2>&1; then
        echo "๐ฆ ะะฐะฟััะตะฝะฝัะต ะบะพะฝัะตะนะฝะตัั:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(career|nginx|postgres)" || echo "ะะตั ะทะฐะฟััะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ ะฟัะพะตะบัะฐ"
    else
        echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ ะธะปะธ ะฝะตะดะพัััะฟะตะฝ"
    fi
    
    echo ""
}

# ะคัะฝะบัะธั ะดะปั ะฟะพะบะฐะทะฐ ะฟะพัะปะตะดะฝะธั ะปะพะณะพะฒ
show_recent_logs() {
    echo "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ (ะตัะปะธ ะบะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั):"
    
    if command -v docker > /dev/null 2>&1; then
        # ะะพะบะฐะทัะฒะฐะตะผ ะปะพะณะธ backend
        if docker ps | grep -q "backend"; then
            echo "๐ง Backend ะปะพะณะธ (ะฟะพัะปะตะดะฝะธะต 10 ัััะพะบ):"
            docker logs --tail 10 $(docker ps -q --filter "name=backend") 2>/dev/null || echo "ะะตั ะปะพะณะพะฒ backend"
            echo ""
        fi
        
        # ะะพะบะฐะทัะฒะฐะตะผ ะปะพะณะธ nginx
        if docker ps | grep -q "nginx"; then
            echo "๐ Nginx ะปะพะณะธ (ะฟะพัะปะตะดะฝะธะต 5 ัััะพะบ):"
            docker logs --tail 5 $(docker ps -q --filter "name=nginx") 2>/dev/null || echo "ะะตั ะปะพะณะพะฒ nginx"
            echo ""
        fi
    fi
}

# ะัะฝะพะฒะฝะฐั ััะฝะบัะธั ะผะพะฝะธัะพัะธะฝะณะฐ
main() {
    while true; do
        clear
        echo "๐ ะะพะฝะธัะพัะธะฝะณ ะดะตะฟะปะพั Career Mini App"
        echo "โฐ $(date '+%Y-%m-%d %H:%M:%S')"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""
        
        check_api_status
        check_frontend_status
        check_docker_status
        show_recent_logs
        
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท 30 ัะตะบัะฝะด... (Ctrl+C ะดะปั ะฒััะพะดะฐ)"
        echo "๐ GitHub Actions: https://github.com/expaai/miniapp/actions"
        
        sleep 30
    done
}

# ะะฐะฟััะบ ะผะพะฝะธัะพัะธะฝะณะฐ
main